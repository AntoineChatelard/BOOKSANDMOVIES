
-- Se positionner dans la table ou l'on souhaite crypter des données --
USE BOOKSANDMOVIES
GO

-- Création d'une master key, et de sa protection par mot de passe, la master key permet de chiffrer toute les clés ou certificats qui seront crées dans la base --
CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'password'
GO

-- Création d'un certificat (clé asymétrique avec des options), avec un sujet --
CREATE CERTIFICATE CertifBAM WITH SUBJECT ='Certificat concernant la BDD BOOKSANDMOVIES'
GO

-- Sauvegarder le certificat --
-- Choisir si nécessaire le chemin de sauvegarde
BACKUP CERTIFICATE CertifBAM to FILE ='c:\temp\CertifBAM.cert'
WITH PRIVATE KEY (FILE = 'c:\temp\CertifBAM',
ENCRYPTION BY PASSWORD = 'password')
GO



-- Créer un chiffrement spécifique pour la champ mot de passe de la BDD --
USE BOOKSANDMOVIES;
GO
ALTER TABLE UTILISATEUR
ADD MOTDEPASSE_CRYPT varbinary(MAX) NULL
GO

-- Ouvre la clé symmtrique pour l'utiliser
USE BOOKSANDMOVIES;
GO
UPDATE UTILISATEUR
SET MOTDEPASSE_CRYPT = EncryptByCert (CERT_ID('CertifBAM'), MOTDEPASSE)
FROM dbo.UTILISATEUR;
GO

USE BOOKSANDMOVIES;
GO
ALTER TABLE UTILISATEUR
DROP COLUMN MOTDEPASSE;
GO

-- Créer la clé de chiffrement de la BDD --
CREATE DATABASE ENCRYPTION KEY
WITH ALGORITHM = AES_256
ENCRYPTION BY SERVER CERTIFICATE CertifBAM;
GO

-- Activer le chiffrement --
ALTER DATABASE BOOKSANDMOVIES
SET ENCRYPTION ON;
GO

-- Créer clé symmétrique protégée par un certificat --
USE BOOKSANDMOVIES;
GO
CREATE SYMMETRIC KEY CleSym
 WITH ALGORITHM = AES_128 
 ENCRYPTION BY CERTIFICATE CertifBAM;
GO

-- Créer un encryption spécifique pour la champ mot de passe de la BDD --
USE BOOKSANDMOVIES;
GO
-- Ouvre la clé symmtrique pour l'utiliser
OPEN SYMMETRIC KEY CleSym
DECRYPTION BY CERTIFICATE CertifBAM;
GO
UPDATE UTILISATEUR
SET MOTDEPASSE = EncryptByKey (Key_GUID('CleSym'),MOTDEPASSE)
FROM dbo.UTILISATEUR;
GO
-- Ferme la clé symmétrique -- 
CLOSE SYMMETRIC KEY CleSym;
GO
