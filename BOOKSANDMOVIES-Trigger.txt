-- Trigger se déclenchant avant un insert afin de crypter le mot de passe avant de l'insérer dans la colonne MOTDEPASSE_CRYPT
-- On récupère les données de l'insert et on crypte le mot de passe (MOTDEPASSE_TEMP)
CREATE OR ALTER TRIGGER T_INSERT_UTILISATEUR_CRYPTPASSWORD ON UTILISATEUR
INSTEAD OF INSERT
AS 
BEGIN
	OPEN SYMMETRIC KEY BAMKEY DECRYPTION BY CERTIFICATE BOOKSANDMOVIESCERTIFICATE
	INSERT INTO UTILISATEUR (NOM, PRENOM, ADRESSEMAIL, DATENAISSANCE, MOTDEPASSE_TEMP, LASTCONNEXION, MOTDEPASSE_CRYPT)
	SELECT NOM, PRENOM, ADRESSEMAIL, DATENAISSANCE, '', LASTCONNEXION, EncryptByKey (Key_GUID('BAMKEY'), MOTDEPASSE_TEMP) 
	FROM inserted
	CLOSE SYMMETRIC KEY BAMKEY
END